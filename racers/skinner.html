<!DOCTYPE HTML>
<!--
	Stellar by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>

<head>
    <title>ANXRacers Spaceship Skinner</title>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet"
          href="../assets/css/main.css" />
    <!-- Google tag (gtag.js) -->
    <script async
            src="https://www.googletagmanager.com/gtag/js?id=G-KVX7XGMT9T"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-KVX7XGMT9T');
    </script>

    <noscript>
        <link rel="stylesheet"
              href="../assets/css/noscript.css" />
    </noscript>
</head>

<body class="is-preload">

    <!-- Wrapper -->
    <div id="wrapper">

        <!-- Header -->
        <header id="header">
            <h1>ANXRacers Spaceship Skinner</h1>
            <p>Paint your Ships!</p>
        </header>

        <!-- Main -->
        <div id="main">
            <!-- Content -->
            <section id="userwelcome"
                     class="main">

                <!-- Text -->
                <section>
                    <h2 id="h2UserDisplayName">...</h2><!-- Welcome {UserDisplayName}!  -->
                    <h3 id="h3ShipName"></h3><!-- You are painting {ShipName} -->
                </section>
            </section>

            <!-- Content -->
            <section id="content"
                     class="main"
                     style="display: none;">

                <!-- Text -->
                <section>

                    <div class="row">
                        <div id="rightSide"
                             class="col-8 col-12-medium">

                        </div>
                        <ul id="leftSide"
                            class="alt col-4 col-12-medium">

                        </ul>
                    </div>
                    <hr />
                    <label>Skin Name</label>
                    <input type="text"
                           id="txtSkinName"
                           value=""
                           placeholder="Skin Name">
                    <hr />
                    <a id="btnBuildSkin"
                       class="button icon solid fa-download">Build Skin</a>
                    <br />
                    <progress id="exportProgress"
                              value="0"
                              max="100"
                              style="width: 100%;"></progress>
                    <p>Once you click on 'Build Skin'. Download the '.skin' from below, and send it to <a
                           href="https://t.me/ANXStudios">AEonAX Studios (Discord)</a> or <a
                           href="https://t.me/ANXStudios">AEonAX Studios (Telegram)</a>.
                        Also copy and send image shown below. for it will make it easy to process.
                        <br />
                        "Right click/Press and hold" > "Copy Image" on below image to copy.
                        <br />
                        <br />
                        <br />
                        Once submitted if you want to create another skin for same spaceship please open this webapp
                        again from the game to be able to generate a new skin.
                        <br />
                        Note: Submitting a skin will put it in review queue. Once approved it will be made available in
                        game.
                        *You need to provide a good reason for why you want the skin to be exclusive.
                    <blockquote>
                        By submitting the skin to us, you grant us a non-exclusive, permanent, sub-licensable,
                        royalty-free, irrevocable, and worldwide licence to use,
                        modify, reproduce, create derivative works from, distribute, transmit, perform communicate and
                        exploit your skins (or any
                        part of them)
                    </blockquote>
                    </p>
                    <ul id="ExportArea"
                        class="alt">
                    </ul>
                    <p>
                        Ensure you read the instructions above!
                    </p>
                </section>
            </section>
        </div>
    </div>
    <!-- Footer -->
    <footer id="footer">

        <section></section>
        <section>

            <p>
                To be used for spaceship skinning for ANXRacers game.<br />
                Get it below:
            </p>
            <ul class="icons">
                <li><a href="https://play.google.com/store/apps/details?id=com.aeonax.racers"
                       class="icon brands fa-google-play alt"><span class="label">Google Play Store</span></a></li>
                <li><a href="https://aeonax.itch.io/racers"
                       class="icon brands fa-itch-io alt"><span class="label">Itch.io</span></a></li>
            </ul>
        </section>
        <p class="copyright">&copy; AEonAX Studios. Design: <a href="https://html5up.net">HTML5 UP</a>.</p>
    </footer>
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.2.min.js"
            integrity="sha256-2krYZKh//PcchRtd+H+VyyQoZ/e3EcrkxhM8ycwASPA="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"
            integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"></script>
    <script src="../assets/js/jquery.scrollex.min.js"></script>
    <script src="../assets/js/jquery.scrolly.min.js"></script>
    <script src="../assets/js/browser.min.js"></script>
    <script src="../assets/js/breakpoints.min.js"></script>
    <script src="../assets/js/util.js"></script>
    <script src="../assets/js/main.js"></script>
    <script src="./pablo.min.js"></script>
    <script src="./jscolor.min.js"></script>
    <script>
        var skinnerInput = {
            UserDisplayName: "Voidapilota",
            UserId: "00000000-0000-0000-0000-000000000000",
            ShipId: "00000000-0000-0000-0000-000000000000",
            SkinId: "00000000-0000-0000-0000-000000000000"
        };
        var Ship = undefined;
        var Skin = undefined;
        skinnerInput = undefined;
        try {
            skinnerInput = JSON.parse(atob(location.hash.substr(1)))

            $("#h2UserDisplayName").text(`Welcome ${skinnerInput.UserDisplayName}!`);
            // location.hash = "";
        } catch (error) {
            console.error(error);
            $("#h2UserDisplayName").text("Please open this webapp from Skin Selector in-game!");
        }

        $("#txtSkinName").attr('placeholder', `${skinnerInput.UserDisplayName}'s Skin`);

        var svg = Pablo(document.getElementById("rightSide")).svg({
            width: "100%",
            height: "100%"
        });

        function LoadShip() {
            fetch(`./ships/${skinnerInput.ShipId}.json`)

                .then((response) => {
                    if (!response.ok) {
                        throw new Error('Ship not available for Skinner');
                    }
                    return response.json()
                })
                .then((ship) => {
                    console.log(ship);
                    Ship = ship;
                    $("#h3ShipName").text(`You are painting ${ship.ShipName}.  Loading default skin...`);
                    $("#txtSkinName").attr('placeholder', `${skinnerInput.UserDisplayName}'s ${ship.ShipName} Skin`);
                    LoadShipsDefaultSkinData();
                })
                .catch((error) => {
                    $("#h3ShipName").text(error);
                });
        }
        LoadShip();

        function LoadShipsDefaultSkinData() {
            fetch(`./skins/${skinnerInput.ShipId}.json`)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(`Default Skin for ${Ship.ShipName} not available for Skinner`);
                    }
                    return response.json()
                })
                .then((skin) => {
                    console.log(skin);
                    Skin = skin;
                    $("#h3ShipName").text(`You are painting ${Ship.ShipName}.  Default skin has been loaded below.`);
                    $("#content").show();
                    LoadShipsDefaultSkinVector();
                })
                .catch((error) => {
                    $("#h3ShipName").text(error);
                });

        }
        function isEmpty(value) {
            return typeof value == 'string' && !value.trim() || typeof value == 'undefined' || value === null;
        }

        function LoadShipsDefaultSkinVector() {
            svg.load('./skins/' + skinnerInput.ShipId + '.svg', function onload(a, b, c) {
                svg.find("path, rect").forEach(path => {
                    var pPath = Pablo(path);
                    ["fill", "stroke"].forEach(attr => {
                        var attrValue = pPath.css(attr);
                        if (attrValue != undefined && attrValue != "" && attrValue != "none") {
                            var div = document.createElement("li");
                            var lbl = document.createElement("label");
                            lbl.innerText = (pPath.parent().attr('id') ?? "Unknown") + " - " + attr;
                            div.append(lbl);
                            var inp = document.createElement("input");
                            inp.type = "text"
                            div.append(inp);
                            var myPicker = new JSColor(inp, {
                                alphaChannel: true,
                                value: pPath.css(attr),
                                previewSize: 45,
                                onChange: function (value) {
                                    pPath.css(attr, this.toRGBAString());
                                }
                            })
                            document.getElementById("leftSide").append(div);
                            pPath.on('touchstart click', function () {
                                inp.scrollIntoView({
                                    behavior: "smooth", // or "auto" or "instant"
                                    block: "start" // or "end"
                                });
                                myPicker.show();
                            })
                        }
                    })


                });

                var ReverseThrustersTrailColor = undefined;
                var div = document.createElement("li");
                var lbl = document.createElement("label");
                lbl.innerText = "Reverse Thrusters Trail Color";
                div.append(lbl);
                var inp = document.createElement("input");
                inp.type = "text"
                div.append(inp);
                var myPicker = new JSColor(inp, {
                    alphaChannel: true,
                    value: "#FFFFFFFF",
                    previewSize: 45,
                    onChange: function (value) {
                        debugger;
                        ReverseThrustersTrailColor = this.channels;
                    }
                })
                ReverseThrustersTrailColor = myPicker.channels;
                document.getElementById("leftSide").append(div);

                var MainThrustersTrailColor = undefined;
                var div = document.createElement("li");
                var lbl = document.createElement("label");
                lbl.innerText = "Main Thruster Trail Color";
                div.append(lbl);
                var inp = document.createElement("input");
                inp.type = "text"
                div.append(inp);
                var myPicker = new JSColor(inp, {
                    alphaChannel: true,
                    value: "#FFFFFFFF",
                    previewSize: 45,
                    onChange: function (value) {
                        debugger;
                        MainThrustersTrailColor = this.channels;
                    }
                })
                MainThrustersTrailColor = myPicker.channels;
                document.getElementById("leftSide").append(div);

                div = document.createElement("li");
                lbl = document.createElement("label");
                lbl.innerText = "Exclusivity";
                div.append(lbl);
                var inp = document.createElement("input");
                inp.type = "checkbox"
                inp.id = "cbExclusive"
                var Exclusive = false;
                inp.addEventListener("change", function (e) {
                    Exclusive = e.target.checked;
                })
                div.append(inp);
                lbl = document.createElement("label");
                lbl.innerText = "Is the Skin Exclusive to me*";
                lbl.htmlFor = "cbExclusive"

                div.append(lbl);
                document.getElementById("leftSide").append(div);




                document.getElementById("btnBuildSkin").onclick = function () {
                    if (isEmpty($("#txtSkinName").val())) {
                        $("#txtSkinName").select()[0].scrollIntoView({
                            behavior: "smooth", // or "auto" or "instant"
                            block: "center" // or "end"
                        });

                        $("#txtSkinName").attr('placeholder', `${skinnerInput.UserDisplayName}'s ${Ship.ShipName} Skin - Give a skin name plox!`);
                        return;
                    }
                    var NewSkin = JSON.parse(JSON.stringify(Skin));
                    NewSkin.UserId = skinnerInput.UserId;

                    NewSkin.SkinName = $("#txtSkinName").val().trim();
                    NewSkin.FromShipSkinId = Skin.SkinId;
                    NewSkin.ShipSkinId = skinnerInput.SkinId;
                    NewSkin.UserDisplayName = skinnerInput.UserDisplayName;
                    NewSkin.UserId = skinnerInput.UserId;
                    NewSkin.State = "Edit";
                    NewSkin.LeftReverseThruster.Color = {
                        r: ReverseThrustersTrailColor.r / 255.0,
                        g: ReverseThrustersTrailColor.g / 255.0,
                        b: ReverseThrustersTrailColor.b / 255.0,
                        a: ReverseThrustersTrailColor.a,
                    };
                    NewSkin.RightReverseThruster.Color = {
                        r: ReverseThrustersTrailColor.r / 255.0,
                        g: ReverseThrustersTrailColor.g / 255.0,
                        b: ReverseThrustersTrailColor.b / 255.0,
                        a: ReverseThrustersTrailColor.a,
                    };

                    NewSkin.MainThrusters.forEach((thruster) => {
                        thruster.Color = {
                            r: MainThrustersTrailColor.r / 255.0,
                            g: MainThrustersTrailColor.g / 255.0,
                            b: MainThrustersTrailColor.b / 255.0,
                            a: MainThrustersTrailColor.a,
                        }
                    })

                    NewSkin.Exclusive = Exclusive;

                    var zip = new JSZip();
                    zip.file(skinnerInput.SkinId + '.json', JSON.stringify(NewSkin, null, 2))
                    debugger;
                    document.getElementById("ExportArea").replaceChildren();
                    var progress = document.getElementById("exportProgress");
                    progress.value = 10;

                    svg.attr("width", 512);
                    svg.attr("height", 512);
                    var img512 = svg.toImage("png")[0];
                    var pngBlob512 = svg.toCanvas((canvas) => {
                        canvas[0].toBlob((blob) => {
                            debugger;
                            zip.file(skinnerInput.SkinId + '.512.png', blob)
                        })
                    });
                    img512.style.display = "block";
                    var exportarea = document.getElementById("ExportArea")
                    var div = document.createElement("li");
                    var download = document.createElement('a');
                    div.append(img512)

                    setTimeout(() => {
                        progress.value = 25;
                        svg.attr("width", 100);
                        svg.attr("height", 100);
                        setTimeout(() => {

                            progress.value = 50;
                            // var img100 = svg.toImage("png")[0];
                            var pngBlob100 = svg.toCanvas((canvas) => {
                                canvas[0].toBlob((blob) => {
                                    debugger;
                                    zip.file(skinnerInput.SkinId + '.100.png', blob)
                                })
                            });

                            setTimeout(() => {

                                progress.value = 75;


                                svg.attr("width", "100%");
                                svg.attr("height", "100%");
                                zip.file(skinnerInput.SkinId + '.svg', svg.markup(true))
                                setTimeout(() => {

                                    progress.value = 100;

                                    download = document.createElement('a');
                                    download.className = "button primary"
                                    zip.generateAsync({ type: "base64" })
                                        .then(function (content) {
                                            download.href = "data:application/zip;base64," + content;
                                            download.download = skinnerInput.SkinId + "." + Ship.ShipName + "." + skinnerInput.UserDisplayName + "." + NewSkin.SkinName + '.skin';
                                            download.text = download.download;
                                            div.append(download)
                                            exportarea.append(div)
                                            download.scrollIntoView({
                                                behavior: "smooth", // or "auto" or "instant"
                                                block: "end" // or "end"
                                            });
                                        });
                                }, 250);
                            }, 250);
                        }, 100);
                    }, 250);
                };
            }, true);
        }
    </script>
</body>

</html>